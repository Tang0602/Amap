# ç¦»çº¿åœ°å›¾æŠ€æœ¯æ–¹æ¡ˆé€‰å‹æ–‡æ¡£

## é¡¹ç›®èƒŒæ™¯

### ç›®æ ‡éœ€æ±‚

- ğŸ¯ **çº¯ç¦»çº¿è¿è¡Œ**ï¼šæ— éœ€ä»»ä½•ç½‘ç»œè¿æ¥
- ğŸ¯ **ä»¿çœŸé«˜å¾·åœ°å›¾**ï¼šUIå’Œäº¤äº’ä½“éªŒæ¥è¿‘é«˜å¾·
- ğŸ¯ **AIæµ‹è¯•å‹å¥½**ï¼šæ”¯æŒè‡ªåŠ¨åŒ–æµ‹è¯•å’Œæ¨¡æ‹Ÿå™¨è¿è¡Œ
- ğŸ¯ **æ•°æ®å¯æ§**ï¼šä½¿ç”¨é¢„è®¾æ•°æ®ï¼Œä¾¿äºæµ‹è¯•éªŒè¯

---

## æ–¹æ¡ˆé€‰å‹

### æœ€ç»ˆé€‰æ‹©ï¼šMapsforge å…¨å®¶æ¡¶

ç»è¿‡å¯¹ MapLibre Nativeã€Mapsforgeã€osmdroid ç­‰æ–¹æ¡ˆçš„è¯¦ç»†è¯„ä¼°ï¼Œé€‰æ‹© **Mapsforge å…¨å®¶æ¡¶** ä½œä¸ºæœ€ç»ˆæ–¹æ¡ˆã€‚

### æ–¹æ¡ˆå¯¹æ¯”æ‘˜è¦

| ç»´åº¦ | MapLibre Native | **Mapsforgeï¼ˆé€‰ä¸­ï¼‰** | osmdroid |
|------|-----------------|---------------------|----------|
| ç¦»çº¿æ”¯æŒ | âš ï¸ éœ€è¦è‡ªå®šä¹‰å®ç° | âœ… åŸç”Ÿè®¾è®¡ | âœ… æ”¯æŒ |
| å®ç°è¯­è¨€ | C++ (Native) | **Java (çº¯JVM)** | Java |
| æ¶æ„ä¾èµ– | éœ€è¦.soæ–‡ä»¶ | **æ— æ¶æ„ä¾èµ–** | æ— æ¶æ„ä¾èµ– |
| æ¨¡æ‹Ÿå™¨å…¼å®¹ | éœ€è¦GPUåŠ é€Ÿ | **ä»»æ„æ¨¡æ‹Ÿå™¨** | ä»»æ„æ¨¡æ‹Ÿå™¨ |
| æ•°æ®ä½“ç§¯ | è¾ƒå¤§ | **æœ€å°** | ä¸­ç­‰ |
| è·¯ç”±é›†æˆ | éœ€è‡ªè¡Œé›†æˆ | **GraphHopperåŸç”Ÿæ”¯æŒ** | éœ€è‡ªè¡Œé›†æˆ |
| POIæœç´¢ | éœ€è‡ªè¡Œå®ç° | **å†…ç½®æ”¯æŒ** | æ—  |

---

## æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä»¿çœŸé«˜å¾·åœ°å›¾ App                          â”‚
â”‚                    (Jetpack Compose + MVVM)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   UI å±‚     â”‚  â”‚   ä¸šåŠ¡å±‚    â”‚  â”‚       æ•°æ®å±‚            â”‚ â”‚
â”‚  â”‚  (Compose)  â”‚  â”‚ (ViewModel) â”‚  â”‚   (Repository/Service)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                â”‚                     â”‚               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Mapsforge å…¨å®¶æ¡¶                      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚   æ¸²æŸ“å±‚      â”‚ â”‚    è·¯ç”±å±‚     â”‚ â”‚    æœç´¢å±‚     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  Mapsforge    â”‚ â”‚    BRouter    â”‚ â”‚ Mapsforge POI â”‚ â”‚   â”‚
â”‚  â”‚  â”‚   æ¸²æŸ“å¼•æ“    â”‚ â”‚   è·¯ç”±å¼•æ“    â”‚ â”‚  + SQLite FTS â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚          â”‚                 â”‚                 â”‚         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚                    æ•°æ®å±‚                          â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  wuhan.map  â”‚  brouter/   â”‚  wuhan.poi  â”‚  poi.db â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### UI ç»„ç»‡æ¶æ„ï¼šOverlay æ¨¡å¼

é‡‡ç”¨ **åœ°å›¾ Overlay å±‚å æ¨¡å¼**ï¼Œå‚è€ƒé«˜å¾·/ç™¾åº¦åœ°å›¾çš„äº¤äº’è®¾è®¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        App Navigation                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   MapContainerScreen                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚              MapsforgeMapView (åº•å±‚åœ°å›¾)             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                   å§‹ç»ˆå­˜åœ¨ï¼Œå…±äº«å®ä¾‹                  â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚
â”‚  â”‚  â”‚               Overlay Layer (å±‚å  UI)                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  HomeOverlay      â”‚ æœç´¢æ¡† + å¿«æ·å…¥å£        â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  SearchOverlay    â”‚ æœç´¢æ¡† + ç»“æœåˆ—è¡¨        â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  DetailOverlay    â”‚ POI è¯¦æƒ…å¡ç‰‡             â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  RoutePlanningOverlay â”‚ èµ·ç»ˆç‚¹ + è·¯çº¿ä¿¡æ¯    â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   NavigationScreen (ç‹¬ç«‹é¡µé¢)              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚         ç‹¬ç«‹çš„ MapsforgeMapView + å¯¼èˆª UI            â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡ç†å¿µ**ï¼š

| é¡µé¢ | ç»„ç»‡æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| ä¸»é¡µ (Home) | Overlay | åœ°å›¾ä¸Šå åŠ æœç´¢æ¡†å’Œå¿«æ·å…¥å£ |
| æœç´¢é¡µ (Search) | Overlay | åœ°å›¾ä¸Šå åŠ æœç´¢ç•Œé¢ï¼Œå¯å®æ—¶æŸ¥çœ‹ POI ä½ç½® |
| è¯¦æƒ…é¡µ (Detail) | Overlay | åœ°å›¾ä¸Šå åŠ  POI è¯¦æƒ…å¡ç‰‡ï¼Œåœ°å›¾è‡ªåŠ¨å®šä½åˆ° POI |
| è·¯çº¿è§„åˆ’é¡µ (RoutePlanning) | Overlay | åœ°å›¾ä¸Šå åŠ è·¯çº¿ä¿¡æ¯ï¼Œæ˜¾ç¤ºèµ·ç»ˆç‚¹å’Œè·¯çº¿ |
| å¯¼èˆªé¡µ (Navigation) | **ç‹¬ç«‹é¡µé¢** | æœ‰è‡ªå·±çš„åœ°å›¾å®ä¾‹ï¼Œä¸“æ³¨äºå¯¼èˆªä½“éªŒ |

**ä¼˜åŠ¿**ï¼š
- ğŸ¯ **ç”¨æˆ·ä½“éªŒè¿è´¯**ï¼šåˆ‡æ¢é¡µé¢æ—¶åœ°å›¾ä½ç½®ã€ç¼©æ”¾çº§åˆ«ä¿æŒè¿ç»­
- ğŸ¯ **äº¤äº’è‡ªç„¶**ï¼šç”¨æˆ·å§‹ç»ˆå¯ä»¥ä¸åœ°å›¾äº¤äº’
- ğŸ¯ **æ€§èƒ½ä¼˜åŒ–**ï¼šå…±äº«ä¸€ä¸ªåœ°å›¾å®ä¾‹ï¼Œå‡å°‘å†…å­˜å¼€é”€
- ğŸ¯ **ç¬¦åˆç”¨æˆ·ä¹ æƒ¯**ï¼šä¸é«˜å¾·/ç™¾åº¦åœ°å›¾äº¤äº’æ–¹å¼ä¸€è‡´

### ç»„ä»¶è¯´æ˜

#### 1. æ¸²æŸ“å±‚ï¼šMapsforge

- **åŠŸèƒ½**ï¼šç¦»çº¿çŸ¢é‡åœ°å›¾æ¸²æŸ“
- **æ•°æ®æ ¼å¼**ï¼š`.map` æ–‡ä»¶
- **ç‰¹ç‚¹**ï¼š
  - çº¯ Java å®ç°ï¼Œæ—  Native ä¾èµ–
  - æ”¯æŒè‡ªå®šä¹‰æ¸²æŸ“ä¸»é¢˜ï¼ˆXMLæ ¼å¼ï¼‰
  - æ”¯æŒç¼©æ”¾ã€å¹³ç§»ã€æ—‹è½¬ç­‰åœ°å›¾æ“ä½œ
  - æ”¯æŒæ ‡è®°ç‚¹ï¼ˆMarkerï¼‰ã€è·¯çº¿ï¼ˆPolylineï¼‰ç»‘åˆ¶

#### 2. è·¯ç”±å±‚ï¼šBRouterï¼ˆæ¨èï¼‰ / GraphHopperï¼ˆå¤‡é€‰ï¼‰

> âš ï¸ **é‡è¦æ›´æ–°**ï¼šGraphHopper ä» 2.0 ç‰ˆæœ¬èµ·ä¸å†å®˜æ–¹æ”¯æŒ Android ç¦»çº¿è·¯ç”±ã€‚
> é¡¹ç›®å·²è¿ç§»åˆ° **BRouter** ä½œä¸ºé»˜è®¤è·¯ç”±å¼•æ“ã€‚
> è¯¦è§ [BRouter è¿ç§»æ–¹æ¡ˆ](./BROUTER_MIGRATION.md)

**BRouterï¼ˆæ¨èï¼‰**
- **åŠŸèƒ½**ï¼šç¦»çº¿è·¯å¾„è§„åˆ’
- **æ•°æ®æ ¼å¼**ï¼š`.rd5` åˆ†ç‰‡æ–‡ä»¶
- **ç‰¹ç‚¹**ï¼š
  - ä¸“ä¸ºç§»åŠ¨ç«¯è®¾è®¡ï¼Œå†…å­˜å ç”¨ä½
  - æ•°æ®æ ¼å¼ç´§å‡‘ï¼Œä½“ç§¯å°
  - è¢« OsmAndã€Locus Map ç­‰çŸ¥ååº”ç”¨é‡‡ç”¨
  - é«˜åº¦å¯å®šåˆ¶ï¼ˆé€šè¿‡ profile è„šæœ¬ï¼‰

**GraphHopperï¼ˆå·²å¼ƒç”¨ï¼‰**
- **åŠŸèƒ½**ï¼šç¦»çº¿è·¯å¾„è§„åˆ’
- **æ•°æ®æ ¼å¼**ï¼šç›®å½•ç»“æ„ï¼ˆnodes, edges, geometryç­‰ï¼‰
- **ç‰¹ç‚¹**ï¼š
  - çº¯ Java å®ç°
  - æ”¯æŒå¤šç§äº¤é€šæ–¹å¼ï¼ˆé©¾è½¦ã€éª‘è¡Œã€æ­¥è¡Œï¼‰
  - æ”¯æŒé€”ç»ç‚¹è®¾ç½®
  - è¿”å›è¯¦ç»†å¯¼èˆªæŒ‡ä»¤
  - âš ï¸ ä» 2.0 ç‰ˆæœ¬èµ·å®˜æ–¹ä¸å†æ”¯æŒ Android

#### 3. æœç´¢å±‚ï¼šMapsforge POI + SQLite FTS

- **åŠŸèƒ½**ï¼šç¦»çº¿ POI æœç´¢ã€åœ°å€æŸ¥è¯¢
- **æ•°æ®æ ¼å¼**ï¼š`.poi` æ–‡ä»¶ + `.db` SQLiteæ•°æ®åº“
- **ç‰¹ç‚¹**ï¼š
  - Mapsforge POI æä¾›åŸºç¡€æœç´¢
  - SQLite FTS5 æä¾›å…¨æ–‡æœç´¢å¢å¼º
  - æ”¯æŒæ¨¡ç³ŠåŒ¹é…ã€æ‹¼éŸ³æœç´¢ï¼ˆå¯æ‰©å±•ï¼‰

---

## æ•°æ®è§„æ ¼

### æ•°æ®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ ¼å¼ | ç”¨é€” | é¢„ä¼°ä½“ç§¯ï¼ˆæ­¦æ±‰å¸‚ï¼‰ |
|------|------|------|-------------------|
| `wuhan.map` | Mapsforge | åœ°å›¾æ¸²æŸ“ | ~30-50 MB |
| `brouter/` | BRouter ç›®å½• | è·¯ç”±è§„åˆ’ï¼ˆæ¨èï¼‰ | ~20-40 MB |
| `wuhan-gh/` | GraphHopperç›®å½• | è·¯ç”±è§„åˆ’ï¼ˆå·²å¼ƒç”¨ï¼‰ | ~50-80 MB |
| `wuhan.poi` | Mapsforge POI | POIæœç´¢ | ~10-15 MB |
| `wuhan_poi.db` | SQLite + FTS5 | å¢å¼ºæœç´¢ | ~5-10 MB |
| `theme.xml` | XML | è‡ªå®šä¹‰ä¸»é¢˜ | ~50 KB |
| **æ€»è®¡** | | | **~70-120 MB**ï¼ˆä½¿ç”¨ BRouterï¼‰ |

### æ•°æ®æ¥æº

æ‰€æœ‰æ•°æ®å‡æ¥æºäº **OpenStreetMap (OSM)**ï¼Œå¼€æºå…è´¹ï¼Œå¯è‡ªç”±ä½¿ç”¨ã€‚

### æ•°æ®å‡†å¤‡å·¥å…·é“¾

> âš ï¸ **æ³¨æ„**ï¼šæ•°æ®å‡†å¤‡éœ€è¦åœ¨å¼€å‘æœºï¼ˆPC/Mac/Linuxï¼‰ä¸Šå®Œæˆï¼Œä¸èƒ½åœ¨ Android è®¾å¤‡ä¸Šè¿›è¡Œã€‚

#### å‰ç½®ä¾èµ–

| å·¥å…· | ç”¨é€” | å®‰è£…å‘½ä»¤ |
|------|------|---------|
| osmium-tool | OSM æ•°æ®è£å‰ª | `brew install osmium-tool` |
| OpenJDK 17 | è¿è¡Œ osmosis/GraphHopper | `brew install openjdk@17` |
| Python + osmium | POI æå–è„šæœ¬ | `pip install osmium` |
| Docker (å¯é€‰) | è¿è¡Œ GraphHopper | - |

#### æ•°æ®å‡†å¤‡æµç¨‹

```
china-latest.osm.pbf (1GB)
         â”‚
         â–¼ osmium extract --bbox
    wuhan.osm.pbf (~50MB)
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                  â–¼                  â–¼
    osmosis +           GraphHopper        Python +
    mapsforge-writer                       extract_poi.py
         â”‚                  â”‚                  â”‚
         â–¼                  â–¼                  â–¼
    wuhan.map          wuhan-gh/          wuhan_poi.db
    wuhan.poi          (è·¯ç”±æ•°æ®)          (FTS5æœç´¢)
```

#### è„šæœ¬æ–‡ä»¶

æ•°æ®å‡†å¤‡è„šæœ¬ä½äº `scripts/` ç›®å½•ï¼š

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `scripts/prepare_all.sh` | å®Œæ•´æ•°æ®å‡†å¤‡æµç¨‹ï¼ˆä¸‹è½½ã€è£å‰ªã€ç”Ÿæˆï¼‰ |
| `scripts/04_generate_brouter.sh` | ç”Ÿæˆ BRouter è·¯ç”±æ•°æ®ï¼ˆæ¨èï¼‰ |
| `scripts/04_generate_route.sh` | ç”Ÿæˆ GraphHopper è·¯ç”±æ•°æ®ï¼ˆå·²å¼ƒç”¨ï¼‰ |
| `scripts/extract_poi.py` | ä» OSM æå– POI åˆ° SQLite FTS5 |

**ä½¿ç”¨æ–¹æ³•**ï¼š

```bash
# 1. è¿è¡Œæ•°æ®å‡†å¤‡è„šæœ¬ï¼ˆé»˜è®¤ä½¿ç”¨ BRouterï¼‰
cd scripts
./prepare_all.sh --copy

# æˆ–è€…å•ç‹¬ç”Ÿæˆ BRouter æ•°æ®
./04_generate_brouter.sh -c wuhan

# 2. æ‰‹åŠ¨å¤åˆ¶ï¼ˆå¦‚æœæ²¡ç”¨ --copy é€‰é¡¹ï¼‰
cp map_data/wuhan.map ../app/src/main/assets/map/
cp map_data/wuhan_poi.db ../app/src/main/assets/map/
cp -r map_data/brouter ../app/src/main/assets/map/
```

---

## ä¾èµ–é…ç½®

### æ ¸å¿ƒä¾èµ–

| åº“ | ç‰ˆæœ¬ | ç”¨é€” |
|----|------|------|
| **Mapsforge** | 0.21.0 | ç¦»çº¿åœ°å›¾æ¸²æŸ“ |
| **GraphHopper** | 8.0 | ç¦»çº¿è·¯ç”±è§„åˆ’ |
| **Jetpack Compose** | BOM 2024.02.00 | UI æ¡†æ¶ |
| **Lifecycle ViewModel** | 2.7.0 | MVVM æ¶æ„ |
| **Navigation Compose** | 2.7.7 | é¡µé¢å¯¼èˆª |
| **Coroutines** | 1.7.3 | å¼‚æ­¥å¤„ç† |

### Gradle é…ç½®è¦ç‚¹

```kotlin
// app/build.gradle.kts

android {
    compileSdk = 35
    defaultConfig {
        minSdk = 24
        multiDexEnabled = true  // GraphHopper éœ€è¦
    }
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }
    // GraphHopper éœ€è¦æ’é™¤é‡å¤çš„ META-INF
    packaging {
        resources {
            excludes += "META-INF/DEPENDENCIES"
            excludes += "META-INF/LICENSE*"
            excludes += "META-INF/NOTICE*"
        }
    }
}

dependencies {
    // Mapsforge åœ°å›¾
    implementation("org.mapsforge:mapsforge-core:0.21.0")
    implementation("org.mapsforge:mapsforge-map-android:0.21.0")
    implementation("org.mapsforge:mapsforge-poi-android:0.21.0")
    
    // BRouter ç¦»çº¿è·¯ç”±ï¼ˆä» libs ç›®å½•åŠ è½½ï¼‰
    implementation(fileTree(mapOf("dir" to "libs", "include" to listOf("*.jar"))))
    
    // GraphHopper è·¯ç”±ï¼ˆå·²å¼ƒç”¨ï¼Œä¿ç•™ä½œä¸ºå¤‡é€‰ï¼‰
    // implementation("com.graphhopper:graphhopper-core:8.0") {
    //     exclude(group = "org.eclipse.jetty")
    //     exclude(group = "com.fasterxml.jackson.dataformat", module = "jackson-dataformat-xml")
    // }
    
    implementation("org.slf4j:slf4j-android:1.7.36")
    
    // Jetpack Compose + MVVM
    implementation(platform("androidx.compose:compose-bom:2024.02.00"))
    implementation("androidx.compose.material3:material3")
    implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.7.0")
    implementation("androidx.navigation:navigation-compose:2.7.7")
}
```

> ğŸ’¡ å®Œæ•´é…ç½®å‚è§ `app/build.gradle.kts`

---

## é¡¹ç›®ç»“æ„

é‡‡ç”¨ **Clean Architecture + MVVM + Overlay** åˆ†å±‚æ¶æ„ï¼š

```
app/src/main/
â”œâ”€â”€ assets/                                  # èµ„æºæ–‡ä»¶
â”‚   â””â”€â”€ map/                                 # ç¦»çº¿åœ°å›¾æ•°æ®
â”‚       â”œâ”€â”€ wuhan.map                        # Mapsforge åœ°å›¾æ–‡ä»¶
â”‚       â”œâ”€â”€ wuhan.poi                        # Mapsforge POI æ–‡ä»¶
â”‚       â”œâ”€â”€ wuhan_poi.db                     # SQLite FTS æ•°æ®åº“
â”‚       â””â”€â”€ brouter/                         # BRouter è·¯ç”±æ•°æ®
â”‚           â”œâ”€â”€ segments/                    # .rd5 åˆ†ç‰‡æ–‡ä»¶
â”‚           â””â”€â”€ profiles/                    # .brf é…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ java/com/example/amap_sim/
â”‚   â”‚
â”‚   â”œâ”€â”€ data/                                # ğŸ—„ï¸ æ•°æ®å±‚ï¼ˆData Layerï¼‰
â”‚   â”‚   â”œâ”€â”€ local/                           # æœ¬åœ°æ•°æ®æº
â”‚   â”‚   â”‚   â”œâ”€â”€ AssetsHelper.kt              # Assets æ–‡ä»¶è§£å‹åŠ©æ‰‹
â”‚   â”‚   â”‚   â”œâ”€â”€ OfflineDataManager.kt        # ç¦»çº¿æ•°æ®ç®¡ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ BRouterManager.kt            # BRouter è·¯ç”±å¼•æ“å°è£…
â”‚   â”‚   â”‚   â”œâ”€â”€ MapsforgePoiManager.kt       # Mapsforge POI å°è£…
â”‚   â”‚   â”‚   â””â”€â”€ entity/                      # æ•°æ®å®ä½“
â”‚   â”‚   â”‚       â””â”€â”€ PoiEntity.kt
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ mapper/                          # æ•°æ®æ˜ å°„å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ RouteMapper.kt               # è·¯çº¿æ•°æ®è½¬æ¢
â”‚   â”‚   â”‚   â””â”€â”€ PoiMapper.kt                 # POI æ•°æ®è½¬æ¢
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ repository/                      # Repository å®ç°
â”‚   â”‚       â”œâ”€â”€ MapRepositoryImpl.kt
â”‚   â”‚       â”œâ”€â”€ RouteRepositoryImpl.kt
â”‚   â”‚       â””â”€â”€ SearchRepositoryImpl.kt
â”‚   â”‚
â”‚   â”œâ”€â”€ domain/                              # ğŸ¯ é¢†åŸŸå±‚ï¼ˆDomain Layerï¼‰
â”‚   â”‚   â”œâ”€â”€ model/                           # é¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ LatLng.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ RouteResult.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ RouteInstruction.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ PoiResult.kt
â”‚   â”‚   â”‚   â””â”€â”€ MarkerData.kt
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ repository/                      # Repository æ¥å£
â”‚   â”‚       â”œâ”€â”€ MapRepository.kt
â”‚   â”‚       â”œâ”€â”€ RouteRepository.kt
â”‚   â”‚       â””â”€â”€ SearchRepository.kt
â”‚   â”‚
â”‚   â”œâ”€â”€ ui/                                  # ğŸ¨ UI å±‚ï¼ˆPresentation Layerï¼‰
â”‚   â”‚   â”œâ”€â”€ MainActivity.kt
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ components/                      # å…¨å±€å¯å¤ç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ LoadingOverlay.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ ErrorSnackbar.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ SearchBarDisplay.kt          # æœç´¢æ¡†å±•ç¤ºç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ SearchBarInput.kt            # æœç´¢æ¡†è¾“å…¥ç»„ä»¶
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ common/                          # é€šç”¨é¡µé¢
â”‚   â”‚   â”‚   â””â”€â”€ UnderConstructionScreen.kt   # âš ï¸ åŠŸèƒ½å¼€å‘ä¸­å ä½é¡µ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ navigation/                      # å¯¼èˆª
â”‚   â”‚   â”‚   â”œâ”€â”€ NavGraph.kt                  # å¯¼èˆªå›¾
â”‚   â”‚   â”‚   â””â”€â”€ Screen.kt                    # è·¯ç”±å®šä¹‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ screen/                          # é¡µé¢æ¨¡å—
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ splash/                      # å¯åŠ¨é¡µ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SplashScreen.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SplashViewModel.kt
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ mapcontainer/                # ğŸ—ºï¸ åœ°å›¾å®¹å™¨ï¼ˆOverlay å®¿ä¸»ï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MapContainerScreen.kt    # åœ°å›¾å®¹å™¨ä¸»ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MapContainerViewModel.kt # å…±äº«åœ°å›¾çŠ¶æ€
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MapContainerUiState.kt   # å®¹å™¨ UI çŠ¶æ€
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MapOverlayState.kt       # Overlay çŠ¶æ€å®šä¹‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MapStateController.kt    # åœ°å›¾æ§åˆ¶æ¥å£
â”‚   â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ components/              # åœ°å›¾ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MapsforgeMapView.kt  # Mapsforge åœ°å›¾ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MapControls.kt       # åœ°å›¾æ§åˆ¶æŒ‰é’®
â”‚   â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ overlay/                 # ğŸ¯ Overlay æ¨¡å—ï¼ˆæŒ‰åŠŸèƒ½åˆ†å­ç›®å½•ï¼‰
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ home/                # ğŸ  ä¸»é¡µ
â”‚   â”‚   â”‚   â”‚       â”‚   â””â”€â”€ HomeOverlay.kt
â”‚   â”‚   â”‚   â”‚       â”‚
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ search/              # ğŸ” æœç´¢
â”‚   â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ SearchOverlay.kt
â”‚   â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ SearchViewModel.kt
â”‚   â”‚   â”‚   â”‚       â”‚   â””â”€â”€ SearchUiState.kt
â”‚   â”‚   â”‚   â”‚       â”‚
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ detail/              # ğŸ“ POI è¯¦æƒ…
â”‚   â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ DetailOverlay.kt
â”‚   â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ DetailOverlayViewModel.kt
â”‚   â”‚   â”‚   â”‚       â”‚   â””â”€â”€ DetailOverlayUiState.kt
â”‚   â”‚   â”‚   â”‚       â”‚
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ route/               # ğŸ›£ï¸ è·¯çº¿è§„åˆ’
â”‚   â”‚   â”‚   â”‚           â”œâ”€â”€ RoutePlanningOverlay.kt
â”‚   â”‚   â”‚   â”‚           â”œâ”€â”€ RoutePlanningViewModel.kt
â”‚   â”‚   â”‚   â”‚           â””â”€â”€ RoutePlanningUiState.kt
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ navigation/                  # ğŸ§­ å¯¼èˆªé¡µï¼ˆç‹¬ç«‹é¡µé¢ï¼‰
â”‚   â”‚   â”‚       â”œâ”€â”€ NavigationScreen.kt      # ç‹¬ç«‹å¯¼èˆªé¡µé¢
â”‚   â”‚   â”‚       â”œâ”€â”€ NavigationViewModel.kt
â”‚   â”‚   â”‚       â”œâ”€â”€ NavigationUiState.kt
â”‚   â”‚   â”‚       â””â”€â”€ components/
â”‚   â”‚   â”‚           â”œâ”€â”€ CurrentInstructionCard.kt
â”‚   â”‚   â”‚           â”œâ”€â”€ NavigationControls.kt
â”‚   â”‚   â”‚           â””â”€â”€ NavigationInfoBar.kt
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ theme/                           # ä¸»é¢˜
â”‚   â”‚       â”œâ”€â”€ Color.kt
â”‚   â”‚       â”œâ”€â”€ Theme.kt
â”‚   â”‚       â””â”€â”€ Type.kt
â”‚   â”‚
â”‚   â”œâ”€â”€ common/                              # ğŸ”§ é€šç”¨æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ utils/                           # å·¥å…·ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ GeoUtils.kt                  # åœ°ç†è®¡ç®—å·¥å…·
â”‚   â”‚   â”‚   â””â”€â”€ FormatUtils.kt               # æ ¼å¼åŒ–å·¥å…·
â”‚   â”‚   â”œâ”€â”€ constants/                       # å¸¸é‡
â”‚   â”‚   â”‚   â””â”€â”€ MapConstants.kt
â”‚   â”‚   â””â”€â”€ extension/                       # Kotlin æ‰©å±•å‡½æ•°
â”‚   â”‚       â””â”€â”€ LatLngExtensions.kt
â”‚   â”‚
â”‚   â””â”€â”€ di/                                  # ğŸ’‰ ä¾èµ–æ³¨å…¥
â”‚       â”œâ”€â”€ AmapSimApplication.kt            # Application
â”‚       â””â”€â”€ AppModule.kt                     # Hilt/æ‰‹åŠ¨ DI æ¨¡å—
â”‚
â””â”€â”€ res/                                     # Android èµ„æº
    â”œâ”€â”€ drawable/
    â””â”€â”€ values/
        â”œâ”€â”€ strings.xml
        â””â”€â”€ themes.xml
```

---

## æ ¸å¿ƒæ¨¡å—è¯´æ˜

### åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              UI Layer                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Screen    â”‚â—„â”€â”€â”€â”‚  ViewModel   â”‚    â”‚       components/        â”‚  â”‚
â”‚  â”‚  (Compose)   â”‚    â”‚  (StateFlow) â”‚    â”‚  (å¯å¤ç”¨ Composable)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Domain Layer                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          â–¼                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚   â”‚
â”‚  â”‚  â”‚    model/   â”‚    â”‚ repository/ â”‚  â† æ¥å£å®šä¹‰                  â”‚   â”‚
â”‚  â”‚  â”‚  é¢†åŸŸæ¨¡å‹   â”‚    â”‚   æ¥å£      â”‚                             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           Data Layer                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                             â–¼                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚   local/    â”‚â”€â”€â”€â–ºâ”‚  mapper/    â”‚â”€â”€â”€â–ºâ”‚ repository/ â”‚ â† å®ç°   â”‚   â”‚
â”‚  â”‚  â”‚ æ•°æ®æºç®¡ç†  â”‚    â”‚  æ•°æ®è½¬æ¢   â”‚    â”‚    å®ç°     â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1. æ•°æ®å±‚ (`data/`)

| ç›®å½• | èŒè´£ |
|------|------|
| `local/` | æœ¬åœ°æ•°æ®æºå°è£…ï¼ˆGraphHopperã€Mapsforgeã€SQLiteï¼‰ |
| `mapper/` | Entity â†” Domain Model æ•°æ®è½¬æ¢ |
| `repository/` | Repository æ¥å£çš„å…·ä½“å®ç° |

**local/ å…³é”®ç±»**ï¼š

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `OfflineDataManager.kt` | æ•°æ®è§£å‹ã€ç‰ˆæœ¬æ ¡éªŒã€è·¯å¾„ç®¡ç† |
| `GraphHopperManager.kt` | GraphHopper è·¯ç”±å¼•æ“å°è£… |
| `MapsforgePoiManager.kt` | Mapsforge POI + SQLite FTS å°è£… |

### 2. é¢†åŸŸå±‚ (`domain/`)

| ç›®å½• | èŒè´£ |
|------|------|
| `model/` | çº¯ Kotlin é¢†åŸŸæ¨¡å‹ï¼ˆæ—  Android ä¾èµ–ï¼‰ |
| `repository/` | Repository æ¥å£å®šä¹‰ï¼ˆä¾èµ–å€’ç½®ï¼‰ |

**Repository æ¥å£**ï¼š

| æ¥å£ | ä¸»è¦æ–¹æ³• |
|------|----------|
| `RouteRepository` | `calculateRoute()`, `calculateRouteWithWaypoints()` |
| `SearchRepository` | `searchByKeyword()`, `searchNearby()`, `searchByCategory()` |
| `MapRepository` | `getMapFile()`, `getThemeFile()` |

### 3. UI å±‚ (`ui/`)

| ç›®å½• | èŒè´£ |
|------|------|
| `screen/mapcontainer/` | åœ°å›¾å®¹å™¨ï¼ˆOverlay å®¿ä¸»ï¼‰ |
| `screen/{æ¨¡å—}/` | Overlay æ¨¡å—ï¼ˆOverlay + ViewModel + UiStateï¼‰ |
| `screen/navigation/` | å¯¼èˆªé¡µï¼ˆç‹¬ç«‹é¡µé¢ï¼‰ |
| `components/` | å…¨å±€å¯å¤ç”¨çš„ Composable ç»„ä»¶ |
| `navigation/` | å¯¼èˆªå›¾å®šä¹‰ |
| `theme/` | ä¸»é¢˜é…ç½® |

#### Overlay + MVVM æ¶æ„

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **MVVM** æ˜¯çºµå‘åˆ†å±‚æ¶æ„ï¼ˆæ•°æ®æµ & èŒè´£åˆ†ç¦»ï¼‰
- **Overlay** æ˜¯æ¨ªå‘ UI ç»„ç»‡æ–¹å¼ï¼ˆView å±‚å†…éƒ¨çš„å¸ƒå±€ç­–ç•¥ï¼‰
- ä¸¤è€…æ˜¯**æ­£äº¤**çš„æ¦‚å¿µï¼Œå®Œå…¨å…¼å®¹

**æ–¹æ¡ˆ Aï¼šæ¯ä¸ª Overlay æœ‰ç‹¬ç«‹çš„ ViewModel**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           MapContainerScreen                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        MapContainerViewModel                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ å…±äº«åœ°å›¾çŠ¶æ€ï¼šcenter, zoomLevel, markers, routeResult          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ Overlay åˆ‡æ¢çŠ¶æ€ï¼šoverlayState (Home/Search/Detail/Route)      â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    MapsforgeMapView (åº•å±‚åœ°å›¾)                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                          Overlay Layer                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ HomeOverlay â”‚  â”‚SearchOverlayâ”‚  â”‚DetailOverlayâ”‚  â”‚RoutePlanningâ”‚ â”‚  â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚   Overlay   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ (æ— ç‹¬ç«‹VM)  â”‚  â”‚ SearchVM    â”‚  â”‚ DetailVM    â”‚  â”‚ RoutePlanVM â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ViewModel èŒè´£åˆ†å·¥**ï¼š

| ViewModel | èŒè´£ | è¯´æ˜ |
|-----------|------|------|
| `MapContainerViewModel` | åœ°å›¾çŠ¶æ€ + Overlay åˆ‡æ¢ | å…±äº«ï¼Œç®¡ç†åœ°å›¾ä¸­å¿ƒç‚¹ã€ç¼©æ”¾ã€æ ‡è®°ã€è·¯çº¿ |
| `SearchViewModel` | æœç´¢ä¸šåŠ¡ | ç‹¬ç«‹ï¼Œç®¡ç†æœç´¢å…³é”®è¯ã€ç»“æœåˆ—è¡¨ã€åˆ†ç±» |
| `PoiDetailViewModel` | POI è¯¦æƒ…ä¸šåŠ¡ | ç‹¬ç«‹ï¼Œç®¡ç† POI è¯¦æƒ…ã€æ”¶è—çŠ¶æ€ |
| `RoutePlanningViewModel` | è·¯çº¿è§„åˆ’ä¸šåŠ¡ | ç‹¬ç«‹ï¼Œç®¡ç†èµ·ç»ˆç‚¹ã€è·¯çº¿è®¡ç®— |

**å…³é”®è®¾è®¡è¦ç‚¹**ï¼š

1. **MapStateController æ¥å£**ï¼šå„ä¸šåŠ¡ ViewModel é€šè¿‡æ­¤æ¥å£æ§åˆ¶åœ°å›¾ï¼ˆä¾èµ–å€’ç½®ï¼‰
   - `moveTo(position, zoom)` - ç§»åŠ¨åœ°å›¾ä¸­å¿ƒ
   - `setMarkers(markers)` - è®¾ç½®æ ‡è®°ç‚¹
   - `setRoute(route)` - æ˜¾ç¤ºè·¯çº¿
   - `fitBounds(...)` - é€‚åº”è¾¹ç•Œ

2. **MapOverlayState å¯†å°ç±»**ï¼šå®šä¹‰ Overlay çŠ¶æ€
   - `Home` - ä¸»é¡µ Overlay
   - `Search` - æœç´¢ Overlay
   - `Detail(poiId)` - è¯¦æƒ… Overlay
   - `RoutePlanning(destLat, destLon, destName)` - è·¯çº¿è§„åˆ’ Overlay

3. **MapCommand å‘½ä»¤æ¨¡å¼**ï¼šé€šè¿‡ SharedFlow å‘é€åœ°å›¾æ“ä½œå‘½ä»¤
   - `MoveTo` - ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®
   - `FitBounds` - é€‚åº”è¾¹ç•Œæ¡†
   - `ClearOverlays` - æ¸…é™¤è¦†ç›–ç‰©

**æ•°æ®æµ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     StateFlow      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Repository      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Overlay   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  ä¸šåŠ¡ VM    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    Data     â”‚
â”‚  (Compose)  â”‚                    â”‚             â”‚                     â”‚    Layer    â”‚
â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€ Event â”€â”€â”€â”€â”€â–ºâ”‚             â”‚                     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚ MapStateController
                                          â–¼
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚ MapContainerViewModelâ”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. é€šç”¨æ¨¡å— (`common/`)

| ç›®å½• | èŒè´£ |
|------|------|
| `utils/` | å·¥å…·ç±»ï¼ˆGeoUtilsã€FormatUtilsï¼‰ |
| `constants/` | å¸¸é‡å®šä¹‰ï¼ˆMapConstantsï¼‰ |
| `extension/` | Kotlin æ‰©å±•å‡½æ•° |

### 5. ä¾èµ–æ³¨å…¥ (`di/`)

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `AmapSimApplication.kt` | Application å…¥å£ |
| `AppModule.kt` | ä¾èµ–æä¾›ï¼ˆæ‰‹åŠ¨ DI æˆ– Hilt Moduleï¼‰|

---

## å…³é”®æ•°æ®æ¨¡å‹

| æ¨¡å‹ | ç”¨é€” | å…³é”®å­—æ®µ |
|------|------|----------|
| `LatLng` | ç»çº¬åº¦ | `lat`, `lon` |
| `RouteResult` | è·¯çº¿ç»“æœ | `distance`, `time`, `points`, `instructions` |
| `RouteInstruction` | å¯¼èˆªæŒ‡ä»¤ | `text`, `distance`, `sign`, `location` |
| `PoiResult` | POI ç»“æœ | `id`, `name`, `category`, `lat`, `lon`, `address` |
| `MarkerData` | åœ°å›¾æ ‡è®° | `id`, `position`, `title`, `type` |
| `MapContainerUiState` | åœ°å›¾å®¹å™¨çŠ¶æ€ | `center`, `zoomLevel`, `markers`, `routeResult` |
| `MapOverlayState` | Overlay çŠ¶æ€ | `Home`, `Search`, `Detail`, `RoutePlanning` |

---

## è¿ç§»è®¡åˆ’

### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½ï¼ˆå·²å®Œæˆ âœ…ï¼‰

- [x] æ›´æ–° `build.gradle.kts` æ·»åŠ æ‰€æœ‰ä¾èµ–
- [x] æ›´æ–° `libs.versions.toml` é…ç½®
- [x] åœ¨å¼€å‘æœºä¸Šå‡†å¤‡æ­¦æ±‰å¸‚ç¦»çº¿æ•°æ®æ–‡ä»¶
- [x] å°†æ•°æ®æ–‡ä»¶æ”¾å…¥ `app/src/main/assets/map/` ç›®å½•

### é˜¶æ®µäºŒï¼šæ ¸å¿ƒæœåŠ¡ï¼ˆå·²å®Œæˆ âœ…ï¼‰

- [x] å®ç° `OfflineDataManager` æ•°æ®ç®¡ç†å™¨
- [x] å®ç° `BRouterManager` è·¯ç”±æœåŠ¡
- [x] å®ç° `OfflineSearchService` æœç´¢æœåŠ¡
- [x] åˆ›å»º `AmapSimApplication` åº”ç”¨ç±»

### é˜¶æ®µä¸‰ï¼šåœ°å›¾æ¸²æŸ“ï¼ˆå·²å®Œæˆ âœ…ï¼‰

- [x] å®ç° `MapsforgeMapView` Compose ç»„ä»¶
- [x] å®ç°åœ°å›¾æ ‡è®°ç‚¹ï¼ˆMarkerï¼‰åŠŸèƒ½
- [x] å®ç°è·¯çº¿ç»˜åˆ¶ï¼ˆPolylineï¼‰åŠŸèƒ½
- [x] å®ç°åœ°å›¾äº¤äº’ï¼ˆç‚¹å‡»ã€é•¿æŒ‰ç­‰ï¼‰

### é˜¶æ®µå››ï¼šUI é¡µé¢ - ç‹¬ç«‹é¡µé¢ç‰ˆï¼ˆå·²å®Œæˆ âœ…ï¼‰

- [x] å®ç°å¯åŠ¨é¡µï¼ˆæ•°æ®åˆå§‹åŒ–ï¼‰
- [x] å®ç°ä¸»é¡µï¼ˆåœ°å›¾ + æœç´¢æ¡†ï¼‰
- [x] å®ç°æœç´¢é¡µ
- [x] å®ç° POI è¯¦æƒ…é¡µ
- [x] å®ç°è·¯çº¿è§„åˆ’é¡µ
- [x] å®ç°å¯¼èˆªé¡µ

### é˜¶æ®µäº”ï¼šOverlay æ¶æ„é‡æ„ï¼ˆè¿›è¡Œä¸­ ğŸš§ï¼‰

**ç›®æ ‡**ï¼šå°†ä¸»é¡µã€æœç´¢é¡µã€è¯¦æƒ…é¡µã€è·¯çº¿è§„åˆ’é¡µé‡æ„ä¸ºåœ°å›¾ Overlay æ¨¡å¼

#### 5.1 åˆ›å»ºåœ°å›¾å®¹å™¨ï¼ˆ1å¤©ï¼‰

- [ ] åˆ›å»º `MapContainerScreen.kt` åœ°å›¾å®¹å™¨ç»„ä»¶
- [ ] åˆ›å»º `MapContainerViewModel.kt` å…±äº«åœ°å›¾çŠ¶æ€
- [ ] åˆ›å»º `MapContainerUiState.kt` å®¹å™¨ UI çŠ¶æ€
- [ ] åˆ›å»º `MapOverlayState.kt` Overlay çŠ¶æ€å®šä¹‰
- [ ] åˆ›å»º `MapStateController.kt` åœ°å›¾æ§åˆ¶æ¥å£

#### 5.2 é‡æ„å„é¡µé¢ä¸º Overlayï¼ˆ2å¤©ï¼‰

- [ ] å°† `HomeScreen` é‡æ„ä¸º `HomeOverlay`
- [ ] å°† `SearchScreen` é‡æ„ä¸º `SearchOverlay`
  - [ ] ä¿ç•™ `SearchViewModel`ï¼Œæ·»åŠ  `MapStateController` ä¾èµ–
  - [ ] æœç´¢ç»“æœåœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºæ ‡è®°ç‚¹
- [ ] å°† `PoiDetailScreen` é‡æ„ä¸º `DetailOverlay`
  - [ ] ä¿ç•™ `PoiDetailViewModel`ï¼Œæ·»åŠ  `MapStateController` ä¾èµ–
  - [ ] POI ä½ç½®åœ¨åœ°å›¾ä¸Šé«˜äº®æ˜¾ç¤º
- [ ] å°† `RoutePlanningScreen` é‡æ„ä¸º `RoutePlanningOverlay`
  - [ ] ä¿ç•™ `RoutePlanningViewModel`ï¼Œæ·»åŠ  `MapStateController` ä¾èµ–
  - [ ] èµ·ç»ˆç‚¹å’Œè·¯çº¿åœ¨åœ°å›¾ä¸Šæ˜¾ç¤º

#### 5.3 å¯¼èˆªå›¾æ›´æ–°ï¼ˆ0.5å¤©ï¼‰

- [ ] æ›´æ–° `NavGraph.kt`ï¼Œåˆå¹¶ä¸»æµç¨‹åˆ° `MapContainerScreen`
- [ ] ä¿ç•™ `NavigationScreen` ä¸ºç‹¬ç«‹é¡µé¢
- [ ] æ·»åŠ  Overlay é—´çš„è½¬åœºåŠ¨ç”»

#### 5.4 æµ‹è¯•ä¸è°ƒä¼˜ï¼ˆ0.5å¤©ï¼‰

- [ ] åŠŸèƒ½æµ‹è¯•ï¼šOverlay åˆ‡æ¢ã€åœ°å›¾äº¤äº’
- [ ] æ€§èƒ½æµ‹è¯•ï¼šå†…å­˜å ç”¨ã€æµç•…åº¦
- [ ] è¾¹ç•Œæƒ…å†µï¼šè¿”å›é”®å¤„ç†ã€çŠ¶æ€æ¢å¤

**é˜¶æ®µäº”é¢„è®¡å·¥æ—¶ï¼š4å¤©**

### é˜¶æ®µå…­ï¼šæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰

- [ ] å®Œæ•´åŠŸèƒ½æµ‹è¯•ï¼ˆçœŸæœº + æ¨¡æ‹Ÿå™¨ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆå†…å­˜ã€å¯åŠ¨é€Ÿåº¦ï¼‰
- [ ] UI ç¾åŒ–å’ŒåŠ¨ç”»è°ƒä¼˜
- [ ] æ–‡æ¡£æ›´æ–°

**æ€»ä½“è¿›åº¦**ï¼šé˜¶æ®µä¸€è‡³å››å·²å®Œæˆï¼Œé˜¶æ®µäº”è¿›è¡Œä¸­

---

## ä¸ç°æœ‰æ¶æ„çš„å¯¹æ¥

### ä¿æŒä¸å˜çš„éƒ¨åˆ†

```
âœ… Jetpack Compose UI æ¡†æ¶
âœ… MVVM æ¶æ„æ¨¡å¼ï¼ˆViewModel + StateFlowï¼‰
âœ… Kotlin åç¨‹
âœ… Clean Architecture åˆ†å±‚
âœ… Repository æ¨¡å¼
```

### Overlay æ¶æ„é‡æ„çš„å˜åŒ–

**å¯¼èˆªç»“æ„å˜åŒ–**ï¼š

```
é‡æ„å‰ï¼ˆç‹¬ç«‹é¡µé¢æ¨¡å¼ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NavGraph                          â”‚
â”‚  Splash â†’ Home â†’ Search â†’ Detail â†’ RoutePlanning    â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Navigation      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é‡æ„åï¼ˆOverlay æ¨¡å¼ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NavGraph                          â”‚
â”‚  Splash â†’ MapContainer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Navigation    â”‚
â”‚              â”‚                                       â”‚
â”‚              â””â”€ Overlay å†…éƒ¨åˆ‡æ¢ï¼š                    â”‚
â”‚                 Home â†” Search â†” Detail â†” RoutePlan  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ViewModel å˜åŒ–**ï¼š

| é‡æ„å‰ | é‡æ„å | è¯´æ˜ |
|--------|--------|------|
| `MapViewModel` | `MapContainerViewModel` | å‡çº§ä¸ºå…±äº«åœ°å›¾çŠ¶æ€ + Overlay åˆ‡æ¢ |
| `SearchViewModel` | `SearchViewModel` | ä¿ç•™ï¼Œæ·»åŠ  `MapStateController` ä¾èµ– |
| `PoiDetailViewModel` | `PoiDetailViewModel` | ä¿ç•™ï¼Œæ·»åŠ  `MapStateController` ä¾èµ– |
| `RoutePlanningViewModel` | `RoutePlanningViewModel` | ä¿ç•™ï¼Œæ·»åŠ  `MapStateController` ä¾èµ– |
| `NavigationViewModel` | `NavigationViewModel` | ä¸å˜ï¼Œç‹¬ç«‹é¡µé¢ |

**æ–°å¢æ¥å£**ï¼š

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `MapStateController` | `moveTo()`, `setMarkers()`, `setRoute()`, `clearRoute()`, `fitBounds()` | å„ä¸šåŠ¡ ViewModel é€šè¿‡æ­¤æ¥å£æ§åˆ¶åœ°å›¾ |

**UI å±‚æ–°å¢/ä¿®æ”¹**ï¼š

```
ğŸ”„ ui/screen/map/ â†’ ui/screen/mapcontainer/    # é‡å‘½å
â• ui/screen/mapcontainer/MapContainerScreen.kt # åœ°å›¾å®¹å™¨
â• ui/screen/mapcontainer/MapContainerViewModel.kt
â• ui/screen/mapcontainer/MapContainerUiState.kt
â• ui/screen/mapcontainer/MapOverlayState.kt   # Overlay çŠ¶æ€
â• ui/screen/mapcontainer/MapStateController.kt # åœ°å›¾æ§åˆ¶æ¥å£

# Overlay æ¨¡å—æŒ‰åŠŸèƒ½åˆ†å­ç›®å½•
ğŸ”„ ui/screen/home/ â†’ ui/screen/mapcontainer/overlay/home/
ğŸ”„ ui/screen/search/ â†’ ui/screen/mapcontainer/overlay/search/
ğŸ”„ ui/screen/detail/ â†’ ui/screen/mapcontainer/overlay/detail/
ğŸ”„ ui/screen/route/ â†’ ui/screen/mapcontainer/overlay/route/

âœ… ui/screen/navigation/*                      # ä¿æŒç‹¬ç«‹é¡µé¢ï¼Œä½ç½®ä¸å˜
```

### æ¶æ„å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | é‡æ„å‰ï¼ˆç‹¬ç«‹é¡µé¢ï¼‰ | é‡æ„åï¼ˆOverlay æ¨¡å¼ï¼‰ |
|------|------------------|---------------------|
| **åœ°å›¾å®ä¾‹** | æ¯ä¸ªé¡µé¢å¯èƒ½æœ‰ç‹¬ç«‹åœ°å›¾ | ä¸»æµç¨‹å…±äº«ä¸€ä¸ªåœ°å›¾å®ä¾‹ |
| **ç”¨æˆ·ä½“éªŒ** | é¡µé¢åˆ‡æ¢æ—¶åœ°å›¾é‡ç½® | åœ°å›¾çŠ¶æ€è¿ç»­ä¿æŒ |
| **å†…å­˜å ç”¨** | è¾ƒé«˜ | è¾ƒä½ï¼ˆå…±äº«åœ°å›¾ï¼‰ |
| **å¯¼èˆªç»“æ„** | æ‰å¹³åŒ– | ä¸»å®¹å™¨ + å†…éƒ¨çŠ¶æ€æœº |
| **ViewModel** | å„è‡ªç‹¬ç«‹ | å…±äº« MapContainerVM + ä¸šåŠ¡ VM |
| **ä»£ç å¤æ‚åº¦** | è¾ƒä½ | ä¸­ç­‰ |
| **ç¬¦åˆé«˜å¾·ä½“éªŒ** | âŒ ä¸å¤Ÿæ¥è¿‘ | âœ… é«˜åº¦æ¥è¿‘ |

---

## æ³¨æ„äº‹é¡¹

### 0. æœªå®ç°åŠŸèƒ½å¤„ç†

**æ‰€æœ‰æœªå®ç°åŠŸèƒ½çš„æŒ‰é’®éƒ½åº”è·³è½¬åˆ° `UnderConstructionScreen`**

| æ–‡ä»¶ | ä½ç½® | ç”¨é€” |
|------|------|------|
| `UnderConstructionScreen.kt` | `ui/screen/common/` | åŠŸèƒ½å¼€å‘ä¸­å ä½é¡µ |

**ä½¿ç”¨åœºæ™¯**ï¼š
- åº•éƒ¨å¯¼èˆªæ ä¸­æœªå®ç°çš„ Tab
- å¿«æ·å…¥å£ä¸­æœªå®ç°çš„åŠŸèƒ½ï¼ˆå¦‚ï¼šé©¾è½¦ã€éª‘è¡Œã€æ­¥è¡Œç‹¬ç«‹å…¥å£ï¼‰
- è®¾ç½®é¡µä¸­æœªå®ç°çš„é€‰é¡¹
- ä»»ä½•æš‚æœªå¼€å‘å®Œæˆçš„åŠŸèƒ½å…¥å£

**å‚æ•°**ï¼š`title`ï¼ˆæ ‡é¢˜ï¼‰ã€`description`ï¼ˆæè¿°ï¼‰ã€`icon`ï¼ˆå›¾æ ‡ï¼‰ã€`onNavigateBack`ï¼ˆè¿”å›å›è°ƒï¼‰

**ç›®çš„**ï¼š
- æä¾›ç»Ÿä¸€çš„ç”¨æˆ·ä½“éªŒ
- é¿å…ç‚¹å‡»æ— å“åº”çš„æŒ‰é’®
- æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·åŠŸèƒ½å¼€å‘çŠ¶æ€

---

### 1. æ•°æ®æ–‡ä»¶ä½“ç§¯

ç¦»çº¿æ•°æ®æ–‡ä»¶çº¦ 100-160MBï¼Œä¼šæ˜¾è‘—å¢åŠ  APK ä½“ç§¯ã€‚å»ºè®®ï¼š
- ä½¿ç”¨ App Bundle åˆ†å‘
- æˆ–é¦–æ¬¡å¯åŠ¨æ—¶ä»æœåŠ¡å™¨ä¸‹è½½æ•°æ®

### 2. å†…å­˜ç®¡ç†

GraphHopper åŠ è½½å¤§å‹å›¾æ—¶å¯èƒ½å ç”¨è¾ƒå¤šå†…å­˜ï¼š
- å»ºè®® `minSdk >= 24`
- åœ¨ `Application.onTrimMemory()` ä¸­å¤„ç†å†…å­˜è­¦å‘Š

### 3. é¦–æ¬¡å¯åŠ¨

é¦–æ¬¡å¯åŠ¨éœ€è¦è§£å‹æ•°æ®æ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦ 10-30 ç§’ï¼š
- æ˜¾ç¤ºè¿›åº¦æ¡æç¤ºç”¨æˆ·
- è€ƒè™‘åå°é¢„åŠ è½½

### 4. ProGuard é…ç½®

å¦‚æœå¯ç”¨ä»£ç æ··æ·†ï¼Œéœ€è¦æ·»åŠ è§„åˆ™ï¼š

```proguard
# app/proguard-rules.pro

# Mapsforge
-keep class org.mapsforge.** { *; }
-dontwarn org.mapsforge.**

# GraphHopper
-keep class com.graphhopper.** { *; }
-dontwarn com.graphhopper.**

# SLF4J
-dontwarn org.slf4j.**
```

---

## ä¼˜åŠ¿æ€»ç»“

### æŠ€æœ¯ä¼˜åŠ¿

1. **100% çº¯ç¦»çº¿**ï¼šæ— éœ€ä»»ä½•ç½‘ç»œè¿æ¥
2. **å…¨æ¶æ„æ”¯æŒ**ï¼šARMã€x86ã€æ¨¡æ‹Ÿå™¨å…¨å…¼å®¹
3. **ä½“ç§¯å°**ï¼šæ•°æ®+ä»£ç çº¦ 100-160MB
4. **å¯æµ‹è¯•**ï¼šæ”¯æŒ CI/CD è‡ªåŠ¨åŒ–æµ‹è¯•
5. **å¯å®šåˆ¶**ï¼šåœ°å›¾æ ·å¼ã€æ•°æ®å†…å®¹å®Œå…¨å¯æ§
6. **å¼€æºç”Ÿæ€**ï¼šOpenStreetMap æ•°æ®æŒç»­æ›´æ–°

---

## å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

- [Mapsforge GitHub](https://github.com/mapsforge/mapsforge)
- [Mapsforge Android å…¥é—¨](https://github.com/mapsforge/mapsforge/blob/master/docs/Getting-Started-Android-App.md)
- [BRouter GitHub](https://github.com/abrensch/brouter) â­ æ¨è
- [BRouter æ•°æ®ä¸‹è½½](https://brouter.de/brouter/segments4/)
- [GraphHopper æ–‡æ¡£](https://www.graphhopper.com/documentation/)ï¼ˆå·²å¼ƒç”¨ Android æ”¯æŒï¼‰
- [OpenStreetMap](https://www.openstreetmap.org/)

### æ•°æ®ä¸‹è½½

- [Geofabrik ä¸­å›½æ•°æ®](https://download.geofabrik.de/asia/china.html)
- [é¢„åˆ¶ Mapsforge åœ°å›¾](https://download.mapsforge.org/)

### å·¥å…·

- [osmium-tool](https://osmcode.org/osmium-tool/) - OSM æ•°æ®å¤„ç†
- [osmosis](https://github.com/openstreetmap/osmosis) - OSM æ•°æ®è½¬æ¢
- [GraphHopper Docker](https://hub.docker.com/r/graphhopper/graphhopper)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š4.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2024å¹´12æœˆ  
**æœ€åæ›´æ–°**ï¼š2024å¹´12æœˆ  
**æ›´æ–°å†…å®¹**ï¼š
- v4.0: æ·»åŠ  Overlay + MVVM æ¶æ„è®¾è®¡ï¼Œé‡æ„ UI ç»„ç»‡æ–¹å¼
- v3.0: è¿ç§»åˆ° BRouter è·¯ç”±å¼•æ“ï¼ˆGraphHopper ä¸å†æ”¯æŒ Androidï¼‰
- v2.0: ä¿®å¤ GraphHopper APIã€å®Œå–„ä»£ç ç¤ºä¾‹ã€æ·»åŠ æ•°æ®ç®¡ç†å™¨ã€è¡¥å…… POI æå–è„šæœ¬

---

## ç›¸å…³æ–‡æ¡£

- [BRouter è¿ç§»æ–¹æ¡ˆ](./BROUTER_MIGRATION.md) - ä» GraphHopper è¿ç§»åˆ° BRouter çš„è¯¦ç»†æŒ‡å—
